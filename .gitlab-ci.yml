stages:
  - build
  - test
  - deploy
  - staging
  - e2e
  - release

services:
  - docker:19.03.12-dind

variables:
  DOCKER_TLS_CERTDIR: ""
  IMAGE: $CI_REGISTRY/skyvalley/auth:$CI_COMMIT_SHORT_SHA
  IMAGE_LATEST: $CI_REGISTRY/skyvalley/auth:latest

build:
  stage: build
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY --username $CI_REGISTRY_USER --password-stdin
  script:
    - docker build -t $IMAGE -t $IMAGE_LATEST .
    - docker push $IMAGE
    - docker push $IMAGE_LATEST

test:
  stage: test
  image: node
  services:
    - redis:latest
    - mongo:latest
  variables:
    REDIS_HOST: redis
    REDIS_PORT: 6379
    MONGODB_HOST: mongo
    MONGODB_PORT: 27017
  script:
    - npm install
    - npm test

staging:
  stage: staging
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  before_script:
    - touch /tmp/config
    - export KUBECONFIG=/tmp/config
    - kubectl config set-cluster k8s --server="https://192.168.2.154:8443"
    - kubectl config set clusters.k8s.certificate-authority-data ${STAGING_CERTIFICATE_AUTHORITY_DATA}
    - kubectl config set users.k8s.client-key-data ${STAGING_USER_KEY}
    - kubectl config set users.k8s.client-certificate-data ${STAGING_USER_CERTIFICATE}
    - kubectl config set-context default --cluster=k8s --user=gitlab
    - kubectl config use-context default
  script:
    - kubectl get nodes

e2e:
  stage: e2e
  trigger:
    project: skyvalley/integration_tests
    branch: master


release:
  stage: release
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY --username $CI_REGISTRY_USER --password-stdin
  script:
    - echo "This is where the image switching should happen"
  only:
    - master
  when: manual